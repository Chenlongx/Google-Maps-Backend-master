<div class="loading-container" id="loadingContainer">
    <div class="loading-message">加载中，请稍候...</div>
</div>
<div id="contentContainer" style="display:none;">
    <header class="page-header">
        <h1 class="page-title">编辑用户</h1>
    </header>
    <div class="main-card">
        <div class="form-container">
            <div class="form-group"><label for="userId">用户ID</label><input type="text" id="userId" name="userId" readonly /></div>
            <div class="form-group"><label for="account">账号</label><input type="text" id="account" name="account" placeholder="请输入账号" /></div>
            <div class="form-group"><label for="password">密码</label><input type="password" id="password" name="password" placeholder="留空则不修改密码" /></div>
            <div class="form-group"><label for="deviceCode">绑定设备码</label><input type="text" id="deviceCode" name="deviceCode" placeholder="此为用户设备唯一标识码" /></div>
            <div class="form-group"><label for="userType">类型</label><select id="userType" name="userType"><option value="regular">正式用户</option><option value="trial">试用用户</option></select></div>
            <div class="form-group"><label for="createdAt">创建时间</label><input type="datetime-local" id="createdAt" name="createdAt" /></div>
            <div class="form-group"><label for="expiresAt">到期时间</label><input type="datetime-local" id="expiresAt" name="expiresAt" /></div>
            <div class="form-group"><label for="aiAuthorized">AI深度获客权限</label><select id="aiAuthorized" name="aiAuthorized"><option value="false">关闭</option><option value="true">开启</option></select></div>
            <div class="form-group"><label for="aiTokens">AI Tokens 数量 (点数)</label><input type="number" id="aiTokens" name="aiTokens" placeholder="请输入用户剩余的点数" min="0" /></div>
            <div class="button-group">
                <button class="cancel-btn" id="cancel-edit-btn">取消</button>
                <button class="save-btn" id="save-user-btn">保存更改</button>
            </div>
        </div>
    </div>
</div>
<div id="customAlert"></div>

<script>
    // 由于此脚本是被动态加载和执行的，我们直接定义函数并调用，而不是等待DOMContentLoaded
    
    // --- 定义此页面所需的全部函数 ---
    function showTimedAlert(message, duration, callback = null) {
        const alertBox = document.getElementById('customAlert');
        if (!alertBox) { alert(message); if (callback) callback(); return; }
        alertBox.textContent = message;
        alertBox.style.display = 'block';
        setTimeout(() => { alertBox.style.display = 'none'; if (callback) { callback(); } }, duration);
    }
    
    function getQueryParam(param) { 
        return new URLSearchParams(window.location.search).get(param); 
    }

    function formatDateTimeLocal(dateTimeStr) {
        if (!dateTimeStr) return '';
        const date = new Date(dateTimeStr);
        if (isNaN(date.getTime())) return '';
        return new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    }

    function toISOStringFromLocal(dateTimeLocal) {
        if (!dateTimeLocal) return null;
        const date = new Date(dateTimeLocal);
        return isNaN(date.getTime()) ? null : date.toISOString();
    }

    async function fetchUserById(userId) {
        const token = localStorage.getItem('authToken');
        if (!token) { showTimedAlert('请先登录', 3000, () => window.location.href = 'login.html'); return null; }
        try {
            const response = await fetch(`/.netlify/functions/getUserById?id=${encodeURIComponent(userId)}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) { throw new Error(`获取用户失败: ${response.status}`); }
            const data = await response.json();
            return data.user; 
        } catch (error) {
            console.error('获取用户信息时出错:', error);
            showTimedAlert('加载用户信息失败，请重试', 3000);
            return null;
        }
    }

    function fillUserForm(user) {
        document.getElementById('userId').value = user.id || '';
        document.getElementById('account').value = user.account || '';
        document.getElementById('password').value = '';
        document.getElementById('userType').value = user.user_type || 'trial';
        document.getElementById('createdAt').value = formatDateTimeLocal(user.created_at);
        document.getElementById('expiresAt').value = formatDateTimeLocal(user.expiry_at);
        document.getElementById('deviceCode').value = user.device_id || '未绑定'; 
        document.getElementById('aiAuthorized').value = user.is_ai_authorized ? 'true' : 'false';
        document.getElementById('aiTokens').value = user.ai_tokens_remaining !== undefined ? user.ai_tokens_remaining : 0;
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('contentContainer').style.display = 'block';
    }

    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const account = document.getElementById('account').value.trim();
        if (!account) { showTimedAlert('账号不能为空', 3000); return; }
        
        const updatedUser = {
            id: userId,
            account: account,
            user_type: document.getElementById('userType').value,
            created_at: toISOStringFromLocal(document.getElementById('createdAt').value),
            expiry_at: toISOStringFromLocal(document.getElementById('expiresAt').value),
            device_id: document.getElementById('deviceCode').value.trim(),
            is_ai_authorized: document.getElementById('aiAuthorized').value === 'true',
            ai_tokens_remaining: parseInt(document.getElementById('aiTokens').value, 10) || 0
        };
        const password = document.getElementById('password').value.trim();
        if (password !== '') { updatedUser.password = password; }

        try {
            const token = localStorage.getItem('authToken');
            if (!token) { showTimedAlert('请先登录', 3000, () => window.location.href = 'login.html'); return; }
            const response = await fetch('/.netlify/functions/updateUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(updatedUser)
            });
            const result = await response.json();
            if (response.ok) {
                showTimedAlert('用户信息已成功保存！', 2000, () => {
                    // 使用JS导航而不是刷新页面
                    window.dispatchEvent(new CustomEvent('navigate', { detail: { path: '/users' } }));
                });
            } else {
                showTimedAlert('保存失败: ' + (result.message || '未知错误'), 3000);
            }
        } catch (error) {
            console.error('保存用户时出错:', error);
            showTimedAlert('保存用户信息时发生网络错误或服务器异常', 3000);
        }
    }
    
    // 页面初始化函数
    async function initializeEditUserPage() {
        const userId = getQueryParam('userId');
        if (!userId) { 
            showTimedAlert('未指定用户ID', 3000, () => {
                window.dispatchEvent(new CustomEvent('navigate', { detail: { path: '/users' } }));
            }); 
            return; 
        }
        const user = await fetchUserById(userId);
        if (!user) { 
            showTimedAlert('无法找到该用户的信息', 3000, () => {
                window.dispatchEvent(new CustomEvent('navigate', { detail: { path: '/users' } }));
            }); 
            return; 
        }
        fillUserForm(user);

        // 绑定事件监听器
        document.getElementById('save-user-btn').onclick = saveUser;
        document.getElementById('cancel-edit-btn').onclick = () => {
             window.dispatchEvent(new CustomEvent('navigate', { detail: { path: '/users' } }));
        };
    }

    // 立即执行初始化逻辑
    initializeEditUserPage();
</script>