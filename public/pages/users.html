<header class="page-header">
    <h1 class="page-title">è°·æ­Œåœ°å›¾åå°ç®¡ç†</h1>
</header>

<section class="stats-grid">
    <div class="stat-card stat-card-earnings">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182.553-.44 1.278-.659 2.003-.659A5.25 5.25 0 0 1 15 8.25" /></svg></div>
        <div class="info">
            <div class="label">é¢„ä¼°æ€»æ”¶å…¥</div>
            <div class="value" id="earnings-display">è®¡ç®—ä¸­...</div>
        </div>
    </div>
    <div class="stat-card stat-card-tokens">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a6 6 0 0 0-7.38-5.84m2.56 5.84a6 6 0 0 1 7.38 5.84m-12.56 0a6 6 0 0 1-7.38-5.84m5.84 2.56a6 6 0 0 0 7.38-5.84m-5.84 2.56a6 6 0 0 0-7.38-5.84" /></svg></div>
        <div class="info" id="master-balance-container">
            <div class="label">Gemini æ€»å¯ç”¨ Tokens 
                <button id="edit-master-balance-btn" title="ç¼–è¾‘æ€»é¢åº¦">âœï¸</button>
            </div>
            <div class="value" id="master-balance-display">åŠ è½½ä¸­...</div>
            <div class="sub-value" id="estimated-usage-display"></div>
        </div>
    </div>
    <div class="stat-card stat-card-users">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-2.278 1 1 0 0 0 0-1.414zM2.879 8.121A9.337 9.337 0 0 1 7 5.845a9.38 9.38 0 0 1 2.625.372M17.12 14.122A9.337 9.337 0 0 1 14.845 17a9.38 9.38 0 0 1-2.625-.372m-10.562 2.278a9.337 9.337 0 0 1-4.12-2.278 1 1 0 0 1 0-1.414zM12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z" /></svg></div>
        <div class="info" id="total-users-container">
            <div class="label">æ€»ç”¨æˆ·æ•°</div>
            <div class="value" id="total-users-display">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <div class="stat-card stat-card-advanced">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></div>
        <div class="info" id="advanced-stats-container">
             <div class="label">ç”¨æˆ·åˆ†ç±»ç»Ÿè®¡</div>
             <div class="advanced-stats-details">
                 <div><strong>æ´»è·ƒ:</strong> <span id="active-users-display" style="color: var(--success-color); font-weight: 600;">-</span></div>
                 <div><strong>è¯•ç”¨:</strong> <span id="trial-users-display" style="color: var(--warning-color); font-weight: 600;">-</span></div>
                 <div><strong>æ­£å¼:</strong> <span id="regular-users-display" style="color: var(--primary-color); font-weight: 600;">-</span></div>
             </div>
        </div>
    </div>
</section>

<div class="main-card">
    <div class="table-controls">
        <div class="search-container">
            <input class="search-input" type="text" placeholder="æŒ‰è´¦å·æœç´¢ç”¨æˆ·...">
            <svg id="clickSearch" class="search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M448 768c176.725333 0 320-143.274667 320-320 0-176.725333-143.274667-320-320-320-176.725333 0-320 143.274667-320 320 0 176.725333 143.274667 320 320 320z m0 42.666667c-200.298667 0-362.666667-162.368-362.666667-362.666667S247.701333 85.333333 448 85.333333s362.666667 162.368 362.666667 362.666667-162.368 362.666667-362.666667 362.666667z m304.917333-27.584a21.333333 21.333333 0 0 1 30.165334-30.165334l150.848 150.848a21.333333 21.333333 0 0 1-30.165334 30.165334l-150.848-150.826667z" fill="currentColor"></path></svg>
        </div>
        <div class="actions-toolbar">
            <a href="/addUser" class="action-button btn-add nav-link-internal">æ·»åŠ ç”¨æˆ·</a>
            <button id="deleteButton" class="action-button btn-delete">åˆ é™¤é€‰ä¸­</button>
            <button id="refreshButton" class="action-button btn-refresh" title="åˆ·æ–°æ•°æ®">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="userTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                    <th>IDåºå·</th>
                    <th>è´¦å·</th>
                    <th>å¯†ç </th>
                    <th>è®¾å¤‡ç </th>
                    <th>ç³»ç»Ÿ</th>
                    <th>ç±»å‹</th>
                    <th id="sort-export-count" style="cursor: pointer;">
                        å¯¼å‡ºæ¬¡æ•° <span id="sort-icon-export-count"></span>
                    </th>
                    <th>æœ€è¿‘å¯¼å‡º</th>
                    <th id="sort-created-at" style="cursor: pointer;">
                        åˆ›å»ºæ—¶é—´ <span id="sort-icon-created-at"></span>
                    </th>
                    <th id="sort-expiry-at" style="cursor: pointer;">
                        åˆ°æœŸæ—¶é—´ <span id="sort-icon-expiry-at"></span>
                    </th>
                    <th>çŠ¶æ€</th>
                    <th>AIæƒé™</th>
                    <th>AI Tokens</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination-container">
        <div class="pagination-info">
            <span id="pagination-info">æ˜¾ç¤ºç¬¬ 1-20 æ¡ï¼Œå…± 0 æ¡è®°å½•</span>
        </div>
        <div class="pagination-controls">
            <button id="first-page-btn" class="pagination-btn" title="é¦–é¡µ">é¦–é¡µ</button>
            <button id="prev-page-btn" class="pagination-btn" title="ä¸Šä¸€é¡µ">ä¸Šä¸€é¡µ</button>
            <div class="page-numbers" id="page-numbers">
                <!-- é¡µç æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="next-page-btn" class="pagination-btn" title="ä¸‹ä¸€é¡µ">ä¸‹ä¸€é¡µ</button>
            <button id="last-page-btn" class="pagination-btn" title="å°¾é¡µ">å°¾é¡µ</button>
        </div>
        <div class="page-size-selector">
            <label for="page-size-select">æ¯é¡µæ˜¾ç¤º:</label>
            <select id="page-size-select">
                <option value="10">10æ¡</option>
                <option value="20" selected>20æ¡</option>
                <option value="50">50æ¡</option>
                <option value="100">100æ¡</option>
            </select>
        </div>
    </div>
</div>

<footer class="footer">
    <p>&copy; 2025 é«˜çº§ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ | ç‰ˆæƒæ‰€æœ‰</p>
</footer>

<div class="loading-container" id="loadingContainer"><div class="loading-message">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div></div>
<div id="customAlert"></div>

<script>
// ä½¿ç”¨â€œç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼â€(IIFE)åŒ…è£¹æ‰€æœ‰ä»£ç ï¼Œåˆ›å»ºç‹¬ç«‹ä½œç”¨åŸŸ
(function() {
    const TOKENS_PER_AI_REQUEST_UsersPage = 3000;
    let allUsers_UsersPage = []; 
    let filteredUsers_UsersPage = []; // è¿‡æ»¤åçš„ç”¨æˆ·æ•°æ®
    let createdAtSortState = 'none';
    let expiryAtSortState = 'none';  // æ–°å¢ï¼šåˆ°æœŸæ—¶é—´æ’åºçŠ¶æ€
    let exportCountSortState = 'none'; // æ–°å¢ï¼šå¯¼å‡ºæ¬¡æ•°æ’åºçŠ¶æ€
    
    // åˆ†é¡µç›¸å…³å˜é‡
    let currentPage_UsersPage = 1;
    let pageSize_UsersPage = 20;
    let totalPages_UsersPage = 1;
    
    // æ•°æ®ç¼“å­˜æœºåˆ¶
    const CACHE_KEY = 'usersPageCache';
    const CACHE_EXPIRY_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜è¿‡æœŸæ—¶é—´
    let lastFetchTime = 0;

    function formatDate_UsersPage(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "æ— æ•ˆæ—¥æœŸ";
        return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    function showTimedAlert_UsersPage(message, duration = 3000, callback = null) {
        const alertBox = document.getElementById('customAlert');
        if (!alertBox) { alert(message); if (callback) callback(); return; }
        alertBox.textContent = message;
        alertBox.style.display = 'block';
        setTimeout(() => { if (alertBox) { alertBox.style.display = 'none'; } if (callback) { callback(); } }, duration);
    }

    // ç¼“å­˜ç®¡ç†å‡½æ•°
    function saveToCache_UsersPage(data) {
        try {
            const cacheData = {
                users: data,
                timestamp: Date.now(),
                version: '1.0' // ç”¨äºç¼“å­˜ç‰ˆæœ¬æ§åˆ¶
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            lastFetchTime = Date.now();
            console.log('ç”¨æˆ·æ•°æ®å·²ç¼“å­˜');
        } catch (error) {
            console.warn('ç¼“å­˜ä¿å­˜å¤±è´¥:', error);
        }
    }

    function loadFromCache_UsersPage() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const cacheData = JSON.parse(cached);
            const now = Date.now();
            
            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
            if (now - cacheData.timestamp > CACHE_EXPIRY_TIME) {
                localStorage.removeItem(CACHE_KEY);
                console.log('ç¼“å­˜å·²è¿‡æœŸï¼Œå·²æ¸…é™¤');
                return null;
            }
            
            console.log('ä»ç¼“å­˜åŠ è½½ç”¨æˆ·æ•°æ®');
            return cacheData.users;
        } catch (error) {
            console.warn('ç¼“å­˜è¯»å–å¤±è´¥:', error);
            localStorage.removeItem(CACHE_KEY);
            return null;
        }
    }

    function clearCache_UsersPage() {
        localStorage.removeItem(CACHE_KEY);
        lastFetchTime = 0;
        console.log('ç”¨æˆ·æ•°æ®ç¼“å­˜å·²æ¸…é™¤');
    }

    function shouldRefreshData_UsersPage() {
        const now = Date.now();
        return (now - lastFetchTime) > CACHE_EXPIRY_TIME;
    }

    async function fetchUsers_UsersPage(forceRefresh = false) {
        // é¦–å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½æ•°æ®
        if (!forceRefresh) {
            const cachedUsers = loadFromCache_UsersPage();
            if (cachedUsers && cachedUsers.length > 0) {
                allUsers_UsersPage = cachedUsers;
                allUsers_UsersPage.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                displayUsers_UsersPage(allUsers_UsersPage);
                calculateAndDisplayEarnings_UsersPage(allUsers_UsersPage);
                
                const totalUsersDisplay = document.getElementById('total-users-display');
                if(totalUsersDisplay) totalUsersDisplay.textContent = allUsers_UsersPage.length;
                
                calculateAndDisplayAdvancedStats_UsersPage(allUsers_UsersPage);
                console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œè·³è¿‡ç½‘ç»œè¯·æ±‚');
                return;
            }
        }

        // ç¼“å­˜æ— æ•ˆæˆ–å¼ºåˆ¶åˆ·æ–°ï¼Œä»æœåŠ¡å™¨è·å–æ•°æ®
        const loadingContainer = document.getElementById('loadingContainer');
        if(loadingContainer) loadingContainer.style.display = 'flex';
        
        try {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showTimedAlert_UsersPage('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 3000, () => { window.location.href = 'login.html'; });
                return;
            }
            
            console.log('ä»æœåŠ¡å™¨è·å–ç”¨æˆ·æ•°æ®...');
            const response = await fetch('/api/getUsers', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
            });
            
            if (response.status === 401) {
                showTimedAlert_UsersPage('ä¼šè¯å·²è¿‡æœŸæˆ–æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 3000, () => { window.location.href = 'login.html'; });
                return;
            }
            if (!response.ok) { throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.statusText}`); }
            
            const data = await response.json();
            allUsers_UsersPage = data.users || [];
            
            // ä¿å­˜åˆ°ç¼“å­˜
            saveToCache_UsersPage(allUsers_UsersPage);
            
            // æŒ‰æ³¨å†Œæ—¶é—´é™åºæ’åºï¼Œæœ€æ–°æ³¨å†Œçš„ç”¨æˆ·åœ¨æœ€ä¸Šé¢
            allUsers_UsersPage.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            displayUsers_UsersPage(allUsers_UsersPage);
            calculateAndDisplayEarnings_UsersPage(allUsers_UsersPage);
            
            const totalUsersDisplay = document.getElementById('total-users-display');
            if(totalUsersDisplay) totalUsersDisplay.textContent = allUsers_UsersPage.length;

            calculateAndDisplayAdvancedStats_UsersPage(allUsers_UsersPage);
        } catch (error) {
            console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            showTimedAlert_UsersPage('æ— æ³•åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 5000);
            displayUsers_UsersPage([]);
        } finally {
            if(loadingContainer) loadingContainer.style.display = 'none';
        }
    }

    async function fetchMasterBalance_UsersPage() {
        const displayElement = document.getElementById('master-balance-display');
        const usageElement = document.getElementById('estimated-usage-display');
        if (!displayElement || !usageElement) return;
        try {
            const token = localStorage.getItem('authToken'); 
            const response = await fetch('/.netlify/functions/getMasterBalance', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await response.json();
            if (data.success) {
                const totalTokens = data.balance;
                displayElement.textContent = totalTokens.toLocaleString('en-US');
                if (TOKENS_PER_AI_REQUEST_UsersPage > 0) {
                    const estimatedUses = Math.floor(totalTokens / TOKENS_PER_AI_REQUEST_UsersPage);
                    usageElement.innerHTML = `é¢„ä¼°å¯ç”¨: <strong style="color: var(--success-color);">${estimatedUses.toLocaleString('en-US')}</strong> æ¬¡`;
                }
            } else {
                displayElement.textContent = 'è·å–å¤±è´¥';
            }
        } catch (error) {
            console.error('è·å–æ€»Tokenä½™é¢å¤±è´¥:', error);
            displayElement.textContent = 'è·å–å¤±è´¥';
        }
    }
    
    async function updateMasterBalance_UsersPage() {
        const displayElement = document.getElementById('master-balance-display');
        if (!displayElement) return;
        const currentBalanceText = displayElement.textContent.replace(/,/g, '');
        const currentBalance = parseInt(currentBalanceText, 10) || 0;
        const newBalanceStr = prompt("è¯·è¾“å…¥æ–°çš„æ€»Tokenæ•°é‡:", currentBalance);
        if (newBalanceStr === null) return;
        const newBalance = parseInt(newBalanceStr.replace(/,/g, ''), 10);
        if (isNaN(newBalance) || newBalance < 0) {
            showTimedAlert_UsersPage('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„éè´Ÿæ•´æ•°ã€‚', 3000);
            return;
        }
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/.netlify/functions/updateMasterBalance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ newBalance })
            });
            const data = await response.json();
            if (data.success) {
                showTimedAlert_UsersPage('æ€»Tokenæ•°å·²æ›´æ–°ï¼', 2000);
                fetchMasterBalance_UsersPage();
            } else {
                throw new Error(data.message || 'æ›´æ–°å¤±è´¥');
            }
        } catch (error) {
            showTimedAlert_UsersPage(`æ›´æ–°å¤±è´¥: ${error.message}`, 3000);
        }
    }


    function displaySkeletonRows_UsersPage(rowCount = 10) {
        const tableBody = document.querySelector("#userTable tbody");
        if (!tableBody) return;
        tableBody.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
        
        const skeletonRowHtml = `
            <tr>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
                <td class="skeleton-cell"><span></span></td>
            </tr>
        `;

        for (let i = 0; i < rowCount; i++) {
            tableBody.innerHTML += skeletonRowHtml;
        }
    }



    // æ›´æ–°åˆ†é¡µä¿¡æ¯æ˜¾ç¤º
    function updatePaginationInfo_UsersPage() {
        const paginationInfo = document.getElementById('pagination-info');
        if (!paginationInfo) return;
        
        const totalUsers = filteredUsers_UsersPage.length;
        const startIndex = (currentPage_UsersPage - 1) * pageSize_UsersPage + 1;
        const endIndex = Math.min(currentPage_UsersPage * pageSize_UsersPage, totalUsers);
        
        if (totalUsers === 0) {
            paginationInfo.textContent = 'æš‚æ— æ•°æ®';
        } else {
            paginationInfo.textContent = `æ˜¾ç¤ºç¬¬ ${startIndex}-${endIndex} æ¡ï¼Œå…± ${totalUsers} æ¡è®°å½•`;
        }
    }

    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    function updatePaginationButtons_UsersPage() {
        const firstPageBtn = document.getElementById('first-page-btn');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const lastPageBtn = document.getElementById('last-page-btn');
        
        if (firstPageBtn) firstPageBtn.disabled = currentPage_UsersPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage_UsersPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage_UsersPage === totalPages_UsersPage;
        if (lastPageBtn) lastPageBtn.disabled = currentPage_UsersPage === totalPages_UsersPage;
        
        // ç”Ÿæˆé¡µç æŒ‰é’®
        const pageNumbers = document.getElementById('page-numbers');
        if (pageNumbers) {
            pageNumbers.innerHTML = '';
            
            // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage_UsersPage - 2);
            let endPage = Math.min(totalPages_UsersPage, currentPage_UsersPage + 2);
            
            // å¦‚æœæ€»é¡µæ•°è¾ƒå°‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            if (totalPages_UsersPage <= 5) {
                startPage = 1;
                endPage = totalPages_UsersPage;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn page-number ${i === currentPage_UsersPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage_UsersPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
    function goToPage_UsersPage(page) {
        if (page < 1 || page > totalPages_UsersPage) return;
        currentPage_UsersPage = page;
        displayCurrentPageUsers_UsersPage();
        updatePaginationInfo_UsersPage();
        updatePaginationButtons_UsersPage();
    }

    // æ˜¾ç¤ºå½“å‰é¡µçš„ç”¨æˆ·æ•°æ®
    function displayCurrentPageUsers_UsersPage() {
        const startIndex = (currentPage_UsersPage - 1) * pageSize_UsersPage;
        const endIndex = startIndex + pageSize_UsersPage;
        const currentPageUsers = filteredUsers_UsersPage.slice(startIndex, endIndex);
        
        const tableBody = document.querySelector("#userTable tbody");
        if(!tableBody) return;
        tableBody.innerHTML = '';
        
        if (currentPageUsers.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 40px; color: #888;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>`;
            return;
        }
        
        currentPageUsers.forEach((user, index) => {
            const row = document.createElement('tr');
            let statusBadge = '';
            if (!user.expiry_at || isNaN(new Date(user.expiry_at).getTime())) {
                statusBadge = '<span class="status-badge status-pending">å¾…å¼€é€š</span>';
            } else {
                const isExpired = new Date(user.expiry_at) < new Date();
                statusBadge = isExpired ? '<span class="status-badge status-expired">å·²è¿‡æœŸ</span>' : '<span class="status-badge status-valid">æœ‰æ•ˆ</span>';
            }
            const aiStatusBadge = `<span class="status-badge ${user.is_ai_authorized ? 'status-valid' : 'status-pending'}">${user.is_ai_authorized ? 'å·²å¼€é€š' : 'æœªå¼€é€š'}</span>`;
            
            // ç”¨æˆ·ç±»å‹æ˜¾ç¤ºé€»è¾‘
            let userTypeText;
            if (user.user_type === 'trial') {
                userTypeText = 'è¯•ç”¨ç”¨æˆ·';
            } else if (user.user_type === 'standard') {
                userTypeText = 'æ ‡å‡†ç”¨æˆ·';
            } else if (user.user_type === 'permanent') {
                userTypeText = 'æ°¸ä¹…ç”¨æˆ·';
            } else if (user.user_type === 'regular') {
                userTypeText = 'æ­£å¼ç”¨æˆ·';
            } else {
                userTypeText = 'æœªçŸ¥ç±»å‹';
            }
            
            // è®¡ç®—å…¨å±€åºå·ï¼ˆè€ƒè™‘åˆ†é¡µï¼‰
            const globalIndex = startIndex + index + 1;
            
            row.innerHTML = `<td><input type="checkbox" class="user-checkbox" data-user-id="${user.id}"></td><td>${globalIndex}</td><td>${user.account || 'N/A'}</td><td>${user.password || 'N/A'}</td><td>${user.device_id || 'æœªç»‘å®š'}</td><td>${user.os_type || 'æœªç»‘å®š'}</td><td>${userTypeText}</td><td>${user.daily_export_count || 0}</td><td>${formatDate_UsersPage(user.last_export_date) || 'æ— è®°å½•'}</td><td>${formatDate_UsersPage(user.created_at)}</td><td>${formatDate_UsersPage(user.expiry_at)}</td><td>${statusBadge}</td><td>${aiStatusBadge}</td><td>${user.ai_tokens_remaining !== undefined ? user.ai_tokens_remaining.toLocaleString('en-US') : 'N/A'}</td><td><button class="edit-button" data-user-id="${user.id}">ç¼–è¾‘</button></td>`;
            tableBody.appendChild(row);
        });
    }

    // ä¿®æ”¹åŸæœ‰çš„displayUsers_UsersPageå‡½æ•°ä»¥æ”¯æŒåˆ†é¡µ
    function displayUsers_UsersPage(usersToDisplay) {
        filteredUsers_UsersPage = usersToDisplay;
        totalPages_UsersPage = Math.ceil(filteredUsers_UsersPage.length / pageSize_UsersPage);
        
        // å¦‚æœå½“å‰é¡µè¶…å‡ºèŒƒå›´ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é¡µ
        if (currentPage_UsersPage > totalPages_UsersPage) {
            currentPage_UsersPage = 1;
        }
        
        displayCurrentPageUsers_UsersPage();
        updatePaginationInfo_UsersPage();
        updatePaginationButtons_UsersPage();
    }

    async function deleteSelectedUsers_UsersPage() {
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showTimedAlert_UsersPage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ç”¨æˆ·ã€‚', 3000);
            return;
        }
        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${selectedCheckboxes.length} ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            return;
        }
        const userIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-user-id'));
        const token = localStorage.getItem('authToken');
        const loadingContainer = document.getElementById('loadingContainer');
        if(loadingContainer) loadingContainer.style.display = 'flex';
        try {
            const response = await fetch('/.netlify/functions/deleteUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ userIds: userIdsToDelete })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showTimedAlert_UsersPage('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼', 3000);
                // åˆ é™¤æˆåŠŸåæ¸…é™¤ç¼“å­˜å¹¶å¼ºåˆ¶åˆ·æ–°
                clearCache_UsersPage();
                fetchUsers_UsersPage(true);
            } else {
                throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤ç”¨æˆ·æ—¶å‡ºé”™:', error);
            showTimedAlert_UsersPage(`åˆ é™¤æ“ä½œå¤±è´¥: ${error.message}`);
        } finally {
            if(loadingContainer) loadingContainer.style.display = 'none';
        }
    }

    function calculateAndDisplayEarnings_UsersPage(users) {
        const pricing = { 
            monthly: 49.9, 
            quarterly: 149.7, 
            yearly: 598.8,
            standard: 49.9  // standardç±»å‹é€šå¸¸æ˜¯æœˆä»˜ç”¨æˆ·
        };
        let totalEarnings = 0;
        users.forEach(user => {
            // è·³è¿‡è¯•ç”¨ç”¨æˆ·å’Œæ²¡æœ‰å®Œæ•´ä¿¡æ¯çš„ç”¨æˆ·
            if (user.user_type === 'trial' || !user.created_at || !user.expiry_at) return;
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹ç›´æ¥è®¡ç®—æ”¶å…¥
            if (user.user_type === 'standard') {
                // standardç±»å‹ç”¨æˆ·é€šå¸¸æ˜¯æœˆä»˜ï¼ŒæŒ‰49.9è®¡ç®—
                totalEarnings += pricing.standard;
            } else if (user.user_type === 'regular') {
                // regularç±»å‹ç”¨æˆ·æ ¹æ®è®¢é˜…æ—¶é•¿è®¡ç®—
                const durationInMs = new Date(user.expiry_at).getTime() - new Date(user.created_at).getTime();
                const durationInDays = durationInMs / (1000 * 60 * 60 * 24);
                if (durationInDays > 330) totalEarnings += pricing.yearly;
                else if (durationInDays > 85) totalEarnings += pricing.quarterly;
                else if (durationInDays > 28) totalEarnings += pricing.monthly;
            } else if (user.user_type === 'permanent') {
                // æ°¸ä¹…ç”¨æˆ·æŒ‰å¹´è´¹è®¡ç®—
                totalEarnings += pricing.yearly;
            }
        });
        const earningsElement = document.getElementById('earnings-display');
        if (earningsElement) {
            earningsElement.textContent = `Â¥ ${totalEarnings.toFixed(2)}`;
        }
    }

    function calculateAndDisplayAdvancedStats_UsersPage(users) {
        let activeUsers = 0, trialUsers = 0, regularUsers = 0;
        const now = new Date();
        users.forEach(user => {
            if (user.user_type === 'trial') trialUsers++; 
            else if (user.user_type === 'regular' || user.user_type === 'permanent' || user.user_type === 'standard') regularUsers++;
            if (user.expiry_at) {
                const expiryDate = new Date(user.expiry_at);
                if (!isNaN(expiryDate.getTime()) && expiryDate > now) activeUsers++;
            }
        });
        const activeUsersDisplay = document.getElementById('active-users-display');
        const trialUsersDisplay = document.getElementById('trial-users-display');
        const regularUsersDisplay = document.getElementById('regular-users-display');
        if(activeUsersDisplay) activeUsersDisplay.textContent = activeUsers;
        if(trialUsersDisplay) trialUsersDisplay.textContent = trialUsers;
        if(regularUsersDisplay) regularUsersDisplay.textContent = regularUsers;
    }

    function initializeUsersPage() {

        // 1. ç«‹å³æ˜¾ç¤ºéª¨æ¶å±ï¼Œè€Œä¸æ˜¯ç­‰å¾… fetch
        displaySkeletonRows_UsersPage(10); 

        fetchUsers_UsersPage();
        fetchMasterBalance_UsersPage();
        
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('#clickSearch');
        const deleteButton = document.getElementById('deleteButton');
        const refreshButton = document.getElementById('refreshButton');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const editMasterBalanceBtn = document.getElementById('edit-master-balance-btn');

        const performSearch = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredUsers = allUsers_UsersPage.filter(user => user.account && user.account.toLowerCase().includes(searchTerm));
            // æœç´¢ç»“æœä¹ŸæŒ‰æ³¨å†Œæ—¶é—´é™åºæ’åº
            filteredUsers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            displayUsers_UsersPage(filteredUsers);
        };

        if(searchButton) searchButton.addEventListener('click', performSearch);
        if(searchInput) searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        if(deleteButton) deleteButton.addEventListener('click', deleteSelectedUsers_UsersPage);
        if(refreshButton) refreshButton.addEventListener('click', () => {
            console.log('æ‰‹åŠ¨åˆ·æ–°æ•°æ®...');
            clearCache_UsersPage();
            fetchUsers_UsersPage(true);
        });
        if(selectAllCheckbox) selectAllCheckbox.addEventListener('change', function () {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => { checkbox.checked = this.checked; });
        });
        if(editMasterBalanceBtn) editMasterBalanceBtn.addEventListener('click', updateMasterBalance_UsersPage);

        // --- åˆ†é¡µæ§ä»¶äº‹ä»¶ç›‘å¬ ---
        const firstPageBtn = document.getElementById('first-page-btn');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const lastPageBtn = document.getElementById('last-page-btn');
        const pageSizeSelect = document.getElementById('page-size-select');

        if(firstPageBtn) firstPageBtn.addEventListener('click', () => goToPage_UsersPage(1));
        if(prevPageBtn) prevPageBtn.addEventListener('click', () => goToPage_UsersPage(currentPage_UsersPage - 1));
        if(nextPageBtn) nextPageBtn.addEventListener('click', () => goToPage_UsersPage(currentPage_UsersPage + 1));
        if(lastPageBtn) lastPageBtn.addEventListener('click', () => goToPage_UsersPage(totalPages_UsersPage));
        
        if(pageSizeSelect) pageSizeSelect.addEventListener('change', (e) => {
            pageSize_UsersPage = parseInt(e.target.value);
            currentPage_UsersPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            displayUsers_UsersPage(filteredUsers_UsersPage.length > 0 ? filteredUsers_UsersPage : allUsers_UsersPage);
        });

        // --- æ–°å¢çš„æ’åºé€»è¾‘ (å®Œæ•´ç‰ˆ) ---
        const sortHeaders = {
            'sort-created-at': { state: 'createdAtSortState', type: 'date', key: 'created_at' },
            'sort-expiry-at': { state: 'expiryAtSortState', type: 'date', key: 'expiry_at' },
            'sort-export-count': { state: 'exportCountSortState', type: 'number', key: 'daily_export_count' }
        };

        // ä¸€ä¸ªé‡ç½®æ‰€æœ‰æ’åºçŠ¶æ€å’Œæ ·å¼çš„å‡½æ•°
        const resetAllSortStates = (exceptId) => {
            for (const id in sortHeaders) {
                if (id !== exceptId) {
                    window[sortHeaders[id].state] = 'none';
                    const header = document.getElementById(id);
                    if (header) header.className = '';
                }
            }
        };
        
        // å¾ªç¯ä¸ºæ‰€æœ‰å¯æ’åºè¡¨å¤´ç»‘å®šäº‹ä»¶
        for (const id in sortHeaders) {
            const header = document.getElementById(id);
            if (header) {
                header.addEventListener('click', () => {
                    resetAllSortStates(id); // ç‚¹å‡»æ—¶å…ˆé‡ç½®å…¶ä»–åˆ—

                    const config = sortHeaders[id];
                    const currentState = window[config.state];

                    if (currentState === 'none' || currentState === 'asc') {
                        // åˆ‡æ¢åˆ°é™åº
                        window[config.state] = 'desc';
                        header.className = 'sorted-desc';
                        allUsers_UsersPage.sort((a, b) => {
                            let valA = a[config.key];
                            let valB = b[config.key];
                            if (config.type === 'date') {
                                // å¤„ç†æ— æ•ˆæˆ–ç©ºæ—¥æœŸï¼Œå°†å…¶æ’åœ¨æœ€å
                                return (valB ? new Date(valB).getTime() : 0) - (valA ? new Date(valA).getTime() : 0);
                            } else { // number
                                return (valB || 0) - (valA || 0);
                            }
                        });
                    } else {
                        // åˆ‡æ¢åˆ°å‡åº
                        window[config.state] = 'asc';
                        header.className = 'sorted-asc';
                        allUsers_UsersPage.sort((a, b) => {
                             let valA = a[config.key];
                             let valB = b[config.key];
                             if (config.type === 'date') {
                                return (valA ? new Date(valA).getTime() : 0) - (valB ? new Date(valB).getTime() : 0);
                            } else { // number
                                return (valA || 0) - (valB || 0);
                            }
                        });
                    }
                    displayUsers_UsersPage(allUsers_UsersPage); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                });
            }
        }
    }

    // ç«‹å³æ‰§è¡Œåˆå§‹åŒ–
    initializeUsersPage();
})();
</script>