<header class="page-header">
    <h1 class="page-title">æ¿€æ´»ç ç®¡ç† (WhatsApp Validator)</h1>
</header>

<section class="stats-grid">
    <div class="stat-card stat-card-tokens">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a6 6 0 0 0-7.38-5.84m2.56 5.84a6 6 0 0 1 7.38 5.84m-12.56 0a6 6 0 0 1-7.38-5.84m5.84 2.56a6 6 0 0 0 7.38-5.84m-5.84 2.56a6 6 0 0 0-7.38-5.84" /></svg></div>
        <div class="info">
            <div class="label">æ€»ç”Ÿæˆæ•°</div>
            <div class="value" id="total-licenses-display">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <div class="stat-card stat-card-users">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></div>
        <div class="info">
            <div class="label">å¯ç”¨æ•°é‡</div>
            <div class="value" id="available-licenses-display">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <div class="stat-card stat-card-earnings">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg></div>
        <div class="info">
            <div class="label">å·²æ¿€æ´»æ•°é‡</div>
            <div class="value" id="active-licenses-display">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <div class="stat-card stat-card-advanced">
        <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg></div>
        <div class="info">
            <div class="label">å·²åŠé”€/è¿‡æœŸ</div>
            <div class="value" id="revoked-licenses-display">åŠ è½½ä¸­...</div>
        </div>
    </div>
</section>

<div class="main-card">
    <div class="table-controls">
        <div class="search-container">
            <input class="search-input" type="text" placeholder="æŒ‰æ¿€æ´»ç ã€æœºå™¨ç æˆ–å¤‡æ³¨æœç´¢...">
            <svg id="clickSearch" class="search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M448 768c176.725333 0 320-143.274667 320-320 0-176.725333-143.274667-320-320-320-176.725333 0-320 143.274667-320 320 0 176.725333 143.274667 320 320 320z m0 42.666667c-200.298667 0-362.666667-162.368-362.666667-362.666667S247.701333 85.333333 448 85.333333s362.666667 162.368 362.666667 362.666667-162.368 362.666667-362.666667 362.666667z m304.917333-27.584a21.333333 21.333333 0 0 1 30.165334-30.165334l150.848 150.848a21.333333 21.333333 0 0 1-30.165334 30.165334l-150.848-150.826667z" fill="currentColor"></path></svg>
        </div>
        <div class="actions-toolbar">
            <button id="generateButton" class="action-button btn-add">ç”Ÿæˆæ¿€æ´»ç </button>
            <button id="deleteButton" class="action-button btn-delete">åˆ é™¤é€‰ä¸­</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="licenseTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                    <th>æ¿€æ´»ç  (KEY)</th>
                    <th>çŠ¶æ€</th>
                    <th>ç»‘å®šçš„æœºå™¨ç </th>
                    <th>æ¿€æ´»æ—¶é—´</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>åˆ°æœŸæ—¶é—´</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody style="text-align: center;"></tbody>
        </table>
    </div>
</div>

<footer class="footer">
    <p>&copy; 2025 é«˜çº§ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ | ç‰ˆæƒæ‰€æœ‰</p>
</footer>

<div class="loading-container" id="loadingContainer"><div class="loading-message">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div></div>
<div id="customAlert"></div>

<script>
(function() {
    // --- 1. å…¨å±€å˜é‡åå·²ä¿®æ­£ ---
    let allLicenses_WhatsAppPage = []; 

    // --- 2. æ‰€æœ‰è¾…åŠ©å‡½æ•°åå·²ä¿®æ­£ ---
    function formatDate_WhatsAppPage(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? "æ— æ•ˆæ—¥æœŸ" : date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    function showTimedAlert_WhatsAppPage(message, duration = 3000) {
        const alertBox = document.getElementById('customAlert');
        if (alertBox) {
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, duration);
        } else {
            alert(message);
        }
    }

    async function fetchWhatsAppLicenses() {
        document.getElementById('loadingContainer').style.display = 'flex';
        try {
            // 1. ä» localStorage è·å– authToken (è¿™æ˜¯ç™»å½•åä¿å­˜çš„)
            const token = localStorage.getItem('authToken'); 

            if (!token) {
                showTimedAlert_WhatsAppPage('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æ•°æ®ã€‚');
                // å¯é€‰ï¼šè·³è½¬å›ç™»å½•é¡µ
                // window.location.href = 'login.html'; 
                return;
            }

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ Token å‘é€è¯·æ±‚ ---
            const response = await fetch('/api/getWhatsAppLicenses', { // URLé‡Œä¸å†éœ€è¦ ?password=...
                method: 'GET', // æ˜ç¡®æŒ‡å®šè¯·æ±‚æ–¹æ³•
                headers: {
                    // åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ Token
                    'Authorization': `Bearer ${token}` 
                }
            });

            if (response.status === 401) {
                showTimedAlert_WhatsAppPage('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
                return;
            }
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'æœåŠ¡å™¨å“åº”é”™è¯¯');
            }

            const data = await response.json();
            
            allLicenses_WhatsAppPage = data.licenses || [];
            displayLicenses_WhatsAppPage(allLicenses_WhatsAppPage);
            updateStats_WhatsAppPage(allLicenses_WhatsAppPage);

        } catch (error) {
            console.error('è·å–æ¿€æ´»ç æ•°æ®å¤±è´¥:', error);
            showTimedAlert_WhatsAppPage(`æ— æ³•åŠ è½½æ¿€æ´»ç åˆ—è¡¨: ${error.message}`);
            displayLicenses_WhatsAppPage([]);
        } finally {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.style.display = 'none';
            }
        }
    }

    function displaySkeletonRows_WhatsAppPage(rowCount = 10) {
        const tableBody = document.querySelector("#licenseTable tbody");
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const skeletonRowHtml = `<tr><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td><td class="skeleton-cell"><span></span></td></tr>`;
        for (let i = 0; i < rowCount; i++) {
            tableBody.innerHTML += skeletonRowHtml;
        }
    }
    
    function displayLicenses_WhatsAppPage(licenses) {
        const tableBody = document.querySelector("#licenseTable tbody");
        if (!tableBody) {
            console.error('WhatsAppé¡µé¢: æ‰¾ä¸åˆ°è¡¨æ ¼tbodyå…ƒç´ ');
            return;
        }
        tableBody.innerHTML = '';
        if (licenses.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px;">æš‚æ— æ¿€æ´»ç æ•°æ®</td></tr>`;
            return;
        }
        
        // å¯¹æ¿€æ´»ç è¿›è¡Œæ’åºï¼šå¯ç”¨çš„æ’åœ¨å‰é¢ï¼Œå·²æ¿€æ´»çš„æ’åœ¨åé¢
        const sortedLicenses = licenses.sort((a, b) => {
            const statusOrder = { 'available': 0, 'active': 1, 'revoked': 2, 'expired': 3 };
            const aOrder = statusOrder[a.status] || 4;
            const bOrder = statusOrder[b.status] || 4;
            return aOrder - bOrder;
        });
        
        sortedLicenses.forEach(license => {
            const row = document.createElement('tr');
            const statusMap = {
                'available': { text: 'å¯ç”¨', class: 'status-valid' },
                'active': { text: 'å·²æ¿€æ´»', class: 'status-pending' },
                'revoked': { text: 'å·²åŠé”€', class: 'status-expired' },
                'expired': { text: 'å·²è¿‡æœŸ', class: 'status-expired' }
            };
            const statusInfo = statusMap[license.status] || { text: license.status, class: '' };
            const statusBadge = `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
            row.innerHTML = `<td><input type="checkbox" class="license-checkbox" data-license-id="${license.id}"></td><td><code class="copyable" title="ç‚¹å‡»å¤åˆ¶">${license.key || 'N/A'}</code></td><td>${statusBadge}</td><td>${license.machine_id || 'æœªç»‘å®š'}</td><td>${formatDate_WhatsAppPage(license.activation_date)}</td><td>${formatDate_WhatsAppPage(license.created_at)}</td><td>${formatDate_WhatsAppPage(license.expiry_at)}</td><td>${license.notes || ''}</td><td><button class="edit-button" data-license-id="${license.id}" title="ç¼–è¾‘å¤‡æ³¨ã€çŠ¶æ€ã€æœ‰æ•ˆæœŸç­‰">ç¼–è¾‘</button></td>`;
            tableBody.appendChild(row);
        });
    }

    function updateStats_WhatsAppPage(licenses) {
        const totalElement = document.getElementById('total-licenses-display');
        const availableElement = document.getElementById('available-licenses-display');
        const activeElement = document.getElementById('active-licenses-display');
        const revokedElement = document.getElementById('revoked-licenses-display');
        
        if (totalElement) totalElement.textContent = licenses.length;
        if (availableElement) availableElement.textContent = licenses.filter(l => l.status === 'available').length;
        if (activeElement) activeElement.textContent = licenses.filter(l => l.status === 'active').length;
        if (revokedElement) revokedElement.textContent = licenses.filter(l => l.status === 'revoked' || l.status === 'expired').length;
    }
    
    async function generateLicenseKey_WhatsAppPage() {
        // åˆ›å»ºè‡ªå®šä¹‰å¯¹è¯æ¡† HTML
        const dialogHtml = `
            <div id="generateDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                <div style="background: #1f2937; border-radius: 12px; padding: 24px; width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <h3 style="color: #fff; margin: 0 0 20px 0; font-size: 18px;">ç”Ÿæˆæ¿€æ´»ç </h3>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 6px;">æ¿€æ´»ç ç±»å‹</label>
                        <select id="licenseTypeSelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #374151; background: #111827; color: #fff; font-size: 14px;">
                            <option value="trial">ğŸ è¯•ç”¨ (3å¤©)</option>
                            <option value="standard" selected>ğŸ“¦ æ ‡å‡†ç‰ˆ</option>
                            <option value="premium">â­ é«˜çº§ç‰ˆ</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 6px;">æœ‰æ•ˆæœŸ</label>
                        <select id="expirySelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #374151; background: #111827; color: #fff; font-size: 14px;">
                            <option value="0">â™¾ï¸ æ°¸ä¹…æœ‰æ•ˆ</option>
                            <option value="365" selected>ğŸ“… 1 å¹´</option>
                            <option value="730">ğŸ“… 2 å¹´</option>
                            <option value="1095">ğŸ“… 3 å¹´</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 6px;">ç”Ÿæˆæ•°é‡</label>
                        <input type="number" id="countInput" value="1" min="1" max="100" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #374151; background: #111827; color: #fff; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button id="cancelBtn" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #374151; background: transparent; color: #9ca3af; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
                        <button id="confirmBtn" style="flex: 1; padding: 10px; border-radius: 6px; border: none; background: #3b82f6; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600;">ç”Ÿæˆ</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        const dialog = document.getElementById('generateDialog');
        const licenseTypeSelect = document.getElementById('licenseTypeSelect');
        const expirySelect = document.getElementById('expirySelect');
        const countInput = document.getElementById('countInput');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        
        // è¯•ç”¨ç±»å‹æ—¶ç¦ç”¨æœ‰æ•ˆæœŸé€‰æ‹©
        licenseTypeSelect.addEventListener('change', function() {
            if (this.value === 'trial') {
                expirySelect.value = '3';
                expirySelect.disabled = true;
                expirySelect.innerHTML = '<option value="3">ğŸ 3 å¤© (è¯•ç”¨å›ºå®š)</option>';
            } else {
                expirySelect.disabled = false;
                expirySelect.innerHTML = `
                    <option value="0">â™¾ï¸ æ°¸ä¹…æœ‰æ•ˆ</option>
                    <option value="365" selected>ğŸ“… 1 å¹´</option>
                    <option value="730">ğŸ“… 2 å¹´</option>
                    <option value="1095">ğŸ“… 3 å¹´</option>
                `;
            }
        });
        
        cancelBtn.addEventListener('click', () => dialog.remove());
        
        confirmBtn.addEventListener('click', async () => {
            const count = parseInt(countInput.value, 10);
            const licenseType = licenseTypeSelect.value;
            const expiryDays = parseInt(expirySelect.value, 10);
            
            if (isNaN(count) || count <= 0 || count > 100) {
                showTimedAlert_WhatsAppPage('è¯·è¾“å…¥1åˆ°100ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ã€‚');
                return;
            }
            
            dialog.remove();
            document.getElementById('loadingContainer').style.display = 'flex';
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/generateWhatsAppLicense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ count, licenseType, expiryDays: expiryDays || null })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showTimedAlert_WhatsAppPage(result.message);
                    fetchWhatsAppLicenses(); 
                } else {
                    throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                showTimedAlert_WhatsAppPage(`æ“ä½œå¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loadingContainer').style.display = 'none';
            }
        });
    }

    async function deleteSelectedLicenses_WhatsAppPage() {
        const selectedCheckboxes = document.querySelectorAll('.license-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showTimedAlert_WhatsAppPage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„æ¿€æ´»ç ã€‚');
            return;
        }
        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${selectedCheckboxes.length} ä¸ªæ¿€æ´»ç å—ï¼Ÿ`)) return;
        
        const licenseIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-license-id'));
        document.getElementById('loadingContainer').style.display = 'flex';
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/deleteWhatsAppLicense', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ licenseIds: licenseIdsToDelete })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showTimedAlert_WhatsAppPage('æ¿€æ´»ç åˆ é™¤æˆåŠŸï¼');
                fetchWhatsAppLicenses();
            } else {
                throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            showTimedAlert_WhatsAppPage(`åˆ é™¤å¤±è´¥: ${error.message}`);
        } finally {
            document.getElementById('loadingContainer').style.display = 'none';
        }
    }

    function initialize_WhatsAppPage() {
        // æ£€æŸ¥DOMæ˜¯å¦å®Œå…¨åŠ è½½
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initialize_WhatsAppPage();
            });
            return;
        }
        
        // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
        const tableBody = document.querySelector("#licenseTable tbody");
        if (!tableBody) {
            console.error('WhatsAppé¡µé¢: DOMå…ƒç´ æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿåˆå§‹åŒ–');
            setTimeout(initialize_WhatsAppPage, 100);
            return;
        }
        
        displaySkeletonRows_WhatsAppPage(10);
        fetchWhatsAppLicenses();
        
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('#clickSearch');
        const generateButton = document.getElementById('generateButton');
        const deleteButton = document.getElementById('deleteButton');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        const performSearch = () => {
            const term = searchInput.value.toLowerCase().trim();
            if (!term) {
                displayLicenses_WhatsAppPage(allLicenses_WhatsAppPage);
                return;
            }
            const filtered = allLicenses_WhatsAppPage.filter(l => 
                (l.key && l.key.toLowerCase().includes(term)) ||
                (l.machine_id && l.machine_id.toLowerCase().includes(term)) ||
                (l.notes && l.notes.toLowerCase().includes(term))
            );
            displayLicenses_WhatsAppPage(filtered);
        };

        if(searchButton) searchButton.addEventListener('click', performSearch);
        if(searchInput) searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        if(generateButton) generateButton.addEventListener('click', generateLicenseKey_WhatsAppPage);
        if(deleteButton) deleteButton.addEventListener('click', deleteSelectedLicenses_WhatsAppPage);
        if(selectAllCheckbox) selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.license-checkbox').forEach(cb => { cb.checked = this.checked; });
        });

        document.querySelector("#licenseTable tbody").addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('copyable')) {
                const keyToCopy = e.target.textContent;
                navigator.clipboard.writeText(keyToCopy).then(() => {
                    showTimedAlert_WhatsAppPage('æ¿€æ´»ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 1500);
                }, (err) => {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    showTimedAlert_WhatsAppPage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                });
            }
        });
    }

    initialize_WhatsAppPage();
})();
</script>