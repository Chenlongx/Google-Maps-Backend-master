<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>用户管理系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/common.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 用户头像下拉菜单样式 */
        .user-profile {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .user-profile:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-profile .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .user-profile #user-menu-arrow {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s ease;
        }
        
        .user-profile.active #user-menu-arrow {
            transform: rotate(180deg);
        }
        
        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
        }
        
        .user-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f8f9fa;
            pointer-events: auto; /* 确保可以点击 */
            position: relative; /* 确保z-index生效 */
            z-index: 1001; /* 确保在菜单之上 */
        }
        
        .user-menu-item:last-child {
            border-bottom: none;
        }
        
        .user-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .user-menu-item.logout:hover {
            background-color: #fff5f5;
            color: #e74c3c;
        }
        
        .user-menu-item i {
            width: 16px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        .user-menu-item.logout i {
            color: #e74c3c;
        }
        
        .user-menu-item span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 点击外部关闭菜单 */
        .user-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            background: transparent;
        }
    </style>
</head>

<body>
    <div class="admin-layout" id="admin-layout">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="nav-text">外贸拓客后台管理</span>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/dashboard" class="nav-link"><svg style="width:20px;height:20px;"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 8.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 8.25 20.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6A2.25 2.25 0 0 1 15.75 3.75h2.25A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25A2.25 2.25 0 0 1 13.5 8.25V6ZM13.5 15.75A2.25 2.25 0 0 1 15.75 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                        </svg><span class="nav-text">汇总仪表盘</span></a></li>
                <li>
                    <a href="/users" class="nav-link"><svg style="width:20px;height:20px;"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-2.278 1 1 0 0 0 0-1.414zM2.879 8.121A9.337 9.337 0 0 1 7 5.845a9.38 9.38 0 0 1 2.625.372M17.12 14.122A9.337 9.337 0 0 1 14.845 17a9.38 9.38 0 0 1-2.625-.372m-10.562 2.278a9.337 9.337 0 0 1-4.12-2.278 1 1 0 0 1 0-1.414zM12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z" />
                        </svg><span class="nav-text">外贸地图拓客</span>
                    </a>
                </li>
                <li><a href="/licenses" class="nav-link">
                    <svg style="width:20px;height:20px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                    </svg>
                    <span class="nav-text">EmailValidator激活码管理</span>
                </a>
                </li>
                <li>
                    <a href="/whatsapp-licenses" class="nav-link"> <svg style="width:20px;height:20px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                        </svg>
                        <span class="nav-text">WhatsApp激活码管理</span> </a>
                </li>
                <li>
                    <a href="/analytics" class="nav-link">
                    <svg style="width:20px;height:20px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v18M9.75 3v18M15.75 3v18M21.75 3v18M3.75 12h18M9.75 12h12M15.75 12h6M3.75 6h18M9.75 6h12M15.75 6h6" /></svg>
                    <span class="nav-text">数据洞察</span>
                    </a>
                </li>
                    
                <li><a href="/settings" class="nav-link"><svg style="width:20px;height:20px;"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9.594 3.94c.09-.542.56-1.003 1.11-1.003h2.593c.55 0 1.02.46 1.11 1.003l.073.437c.095.542.43.994.88 1.282l.436.272c.487.304 1.09.333 1.62.077l.405-.192a.998.998 0 0 1 1.273.96l-.387 1.162c-.173.52-.036 1.093.34 1.47l.393.393a.998.998 0 0 1 0 1.414l-.393.393c-.376.377-.513.95-.34-1.47l.387 1.162a.998.998 0 0 1-1.273.96l-.405-.192c-.53-.256-1.133-.227-1.62.077l-.436.272c-.45.288-.785.74-.88 1.282l-.073.437c-.09.542-.56 1.003-1.11 1.003h-2.593c-.55 0-1.02-.46-1.11-1.003l-.073-.437c-.095-.542-.43-.994-.88-1.282l-.436-.272c-.487-.304-1.09-.333-1.62-.077l-.405.192a.998.998 0 0 1-1.273-.96l.387-1.162c.173-.52-.036-1.093-.34-1.47l-.393-.393a.998.998 0 0 1 0 1.414l.393.393c.376-.377.513-.95-.34-1.47l-.387-1.162a.998.998 0 0 1 1.273-.96l.405.192c.53.256 1.133.227 1.62.077l.436.272c.45.288.785.74.88 1.282l.073.437zM12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5z" />
                        </svg><span class="nav-text">系统设置</span></a></li>
            </ul>
        </nav>

        <div class="main-wrapper">
            <header class="top-bar">
                <button class="hamburger-menu" id="hamburgerMenu"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                        height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg></button>
                <div class="top-bar-right">
                    <div class="theme-switcher">
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle-checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="notification-center" id="notification-center">
                        <button class="notification-bell" id="notification-bell-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                            </svg>
                            <span class="dot" id="notification-dot" style="display: none;"></span>
                        </button>
                        <div class="notification-panel" id="notification-panel">
                            <div class="panel-header">通知</div>
                            <ul class="notification-list" id="notification-list">
                                <li>暂无新通知</li>
                            </ul>
                        </div>
                    </div>
                    <div class="user-profile" id="user-profile" onclick="toggleUserMenu()">
                        <img src="https://i.pravatar.cc/36" alt="User Avatar">
                        <span class="user-name" id="user-name-display">Admin User</span>
                        <i class="fas fa-chevron-down" id="user-menu-arrow"></i>
                    </div>
                    <div class="user-menu" id="user-menu">
                        <div class="user-menu-item" id="switch-account-btn" onclick="handleSwitchAccount(event)">
                            <i class="fas fa-exchange-alt"></i>
                            <span>切换账号</span>
                        </div>
                        <div class="user-menu-item logout" id="logout-btn" onclick="handleLogout(event)">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content" id="main-content"></main>
        </div>
    </div>
    <script src="app.js"></script>
    <script>
        // 显示真实的用户邮箱
        function displayUserEmail() {
            const userInfo = localStorage.getItem('userInfo');
            const userNameDisplay = document.getElementById('user-name-display');
            
            if (userInfo && userNameDisplay) {
                try {
                    const user = JSON.parse(userInfo);
                    if (user.email) {
                        userNameDisplay.textContent = user.email;
                    }
                } catch (error) {
                    console.error('解析用户信息失败:', error);
                }
            }
        }
        
        // 页面加载时显示用户邮箱和绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            displayUserEmail();
            bindUserMenuEvents();
        });
        
        // 绑定用户菜单事件
        function bindUserMenuEvents() {
            console.log('=== 开始绑定用户菜单事件 ===');
            const switchAccountBtn = document.getElementById('switch-account-btn');
            const logoutBtn = document.getElementById('logout-btn');
            
            console.log('切换账号按钮元素:', switchAccountBtn);
            console.log('退出登录按钮元素:', logoutBtn);
            
            if (switchAccountBtn) {
                console.log('绑定切换账号按钮事件...');
                
                // 添加多种事件监听器进行测试
                switchAccountBtn.addEventListener('click', function(e) {
                    console.log('=== 切换账号按钮被点击 (click事件) ===');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('事件已阻止默认行为和冒泡');
                    switchAccount();
                }, true);
                
                // 添加mousedown事件测试
                switchAccountBtn.addEventListener('mousedown', function(e) {
                    console.log('=== 切换账号按钮被点击 (mousedown事件) ===');
                });
                
                // 添加mouseup事件测试
                switchAccountBtn.addEventListener('mouseup', function(e) {
                    console.log('=== 切换账号按钮被点击 (mouseup事件) ===');
                });
                
                console.log('切换账号按钮事件绑定完成');
            } else {
                console.error('切换账号按钮元素未找到！');
            }
            
            if (logoutBtn) {
                console.log('绑定退出登录按钮事件...');
                logoutBtn.addEventListener('click', function(e) {
                    console.log('=== 退出登录按钮被点击 ===');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // 阻止其他事件监听器
                    console.log('事件已阻止默认行为和冒泡');
                    logout();
                }, true); // 使用捕获阶段，确保优先执行
                console.log('退出登录按钮事件绑定完成');
            } else {
                console.error('退出登录按钮元素未找到！');
            }
            
            console.log('=== 用户菜单事件绑定完成 ===');
        }
        
        // 内联事件处理函数
        function handleSwitchAccount(event) {
            console.log('=== handleSwitchAccount 被调用 ===');
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            console.log('内联事件处理：切换账号');
            switchAccount();
        }
        
        function handleLogout(event) {
            console.log('=== handleLogout 被调用 ===');
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            console.log('内联事件处理：退出登录');
            logout();
        }
        
        // 用户菜单相关功能
        let userMenuOpen = false;
        
        function toggleUserMenu() {
            const userProfile = document.getElementById('user-profile');
            const userMenu = document.getElementById('user-menu');
            
            if (userMenuOpen) {
                closeUserMenu();
            } else {
                openUserMenu();
            }
        }
        
        function openUserMenu() {
            const userProfile = document.getElementById('user-profile');
            const userMenu = document.getElementById('user-menu');
            
            userProfile.classList.add('active');
            userMenu.classList.add('show');
            userMenuOpen = true;
            
            // 创建遮罩层，点击外部关闭菜单
            const overlay = document.createElement('div');
            overlay.className = 'user-menu-overlay';
            overlay.onclick = closeUserMenu;
            document.body.appendChild(overlay);
        }
        
        function closeUserMenu() {
            const userProfile = document.getElementById('user-profile');
            const userMenu = document.getElementById('user-menu');
            const overlay = document.querySelector('.user-menu-overlay');
            
            userProfile.classList.remove('active');
            userMenu.classList.remove('show');
            userMenuOpen = false;
            
            if (overlay) {
                overlay.remove();
            }
        }
        
        // 切换账号功能
        function switchAccount() {
            console.log('=== switchAccount函数被调用 ===');
            closeUserMenu();
            
            // 显示确认对话框
            console.log('显示确认对话框...');
            const confirmed = confirm('确定要切换到其他账号吗？当前会话将被清除。');
            console.log('确认对话框结果:', confirmed);
            
            if (confirmed) {
                console.log('用户确认切换账号');
                // 清除当前会话
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                console.log('会话数据已清除');
                
                // 直接跳转，避免被其他代码拦截
                console.log('准备跳转到登录页面...');
                try {
                    // 立即跳转，不使用setTimeout
                    console.log('执行跳转: window.location.href = "login.html"');
                    window.location.href = 'login.html';
                    console.log('跳转命令已执行');
                } catch (error) {
                    console.error('跳转失败:', error);
                    // 备用方案：使用location.replace
                    try {
                        console.log('尝试备用跳转方案: location.replace');
                        location.replace('login.html');
                    } catch (error2) {
                        console.error('备用跳转也失败:', error2);
                        alert('跳转失败，请手动访问登录页面');
                    }
                }
            } else {
                console.log('用户取消切换账号');
            }
        }
        
        // 退出登录功能
        function logout() {
            console.log('=== logout函数被调用 ===');
            closeUserMenu();
            
            // 显示确认对话框
            console.log('显示确认对话框...');
            const confirmed = confirm('确定要退出登录吗？');
            console.log('确认对话框结果:', confirmed);
            
            if (confirmed) {
                console.log('用户确认退出登录');
                // 清除所有本地存储
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                localStorage.removeItem('userType');
                localStorage.removeItem('agentInfo');
                console.log('所有会话数据已清除');
                
                // 直接跳转，避免被其他代码拦截
                console.log('准备跳转到登录页面...');
                try {
                    // 立即跳转，不使用setTimeout
                    console.log('执行跳转: window.location.href = "login.html"');
                    window.location.href = 'login.html';
                    console.log('跳转命令已执行');
                } catch (error) {
                    console.error('跳转失败:', error);
                    // 备用方案：使用location.replace
                    try {
                        console.log('尝试备用跳转方案: location.replace');
                        location.replace('login.html');
                    } catch (error2) {
                        console.error('备用跳转也失败:', error2);
                        alert('跳转失败，请手动访问登录页面');
                    }
                }
            } else {
                console.log('用户取消退出登录');
            }
        }
        
        // 键盘事件处理（ESC键关闭菜单）
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && userMenuOpen) {
                closeUserMenu();
            }
        });
    </script>
</body>

</html>