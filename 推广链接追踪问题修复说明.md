# 推广链接追踪问题修复说明

## 问题描述

客户通过推广链接访问产品页面并下单后，代理仪表板的推广点击量和转化数没有更新。

**测试链接**：
- 产品页面：`https://mediamingle.cn/product.html?id=maps-scraper&ref=V9QGKNTF_google-maps_1759113776066_98mb0`
- 下单页面：`https://mediamingle.cn/checkout.html`

## 问题分析

### 1. 推广链接追踪流程

**正常流程**：
1. 客户访问推广链接 → 触发点击追踪
2. 客户下单 → 触发转化追踪
3. 更新代理仪表板数据

**可能的问题点**：
1. 点击追踪API调用失败
2. 转化追踪逻辑有问题
3. 数据库表结构不匹配
4. 推广码解析错误

### 2. 代码分析

#### 点击追踪逻辑
**文件**：`D:/GoogleMapsScrapeWeb/assets/js/referral-tracker.js`

```javascript
async trackReferralClick() {
    if (!this.referralData) {
        console.log('MediaMingle推广追踪器: 无推广信息，跳过点击追踪');
        return;
    }
    
    const requestData = {
        promotionCode: this.referralData.fullCode,
        agentCode: this.referralData.agentCode,
        productType: this.referralData.productType,
        pageUrl: window.location.href,
        userAgent: navigator.userAgent,
        referrer: document.referrer,
        timestamp: Date.now()
    };
    
    const response = await fetch(`${this.apiBaseUrl}/trackReferralClick`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    });
}
```

#### 转化追踪逻辑
**文件**：`D:/GoogleMapsScrapeWeb/netlify/functions/business-logic.js`

```javascript
async function processReferralCommission(outTradeNo, customerEmail, productId) {
    // 获取订单信息
    const { data: order } = await supabase
        .from('orders')
        .select('*')
        .eq('out_trade_no', outTradeNo)
        .single();
    
    // 获取推广信息
    let referralCode = order.referral_code;
    let agentCode = order.agent_code;
    
    // 更新推广记录的转化次数和佣金
    if (referralCode) {
        const { error: updatePromotionError } = await supabase
            .from('product_promotions')
            .update({ 
                conversions_count: supabase.sql`conversions_count + 1`,
                total_commission: supabase.sql`total_commission + ${commissionAmount}`,
                updated_at: new Date().toISOString()
            })
            .eq('promotion_code', referralCode);
    }
}
```

## 修复方案

### 1. 增强点击追踪调试

**文件**：`D:/GoogleMapsScrapeWeb/assets/js/referral-tracker.js`

**修复内容**：
```javascript
async trackReferralClick() {
    if (!this.referralData) {
        console.log('MediaMingle推广追踪器: 无推广信息，跳过点击追踪');
        return;
    }

    console.log('MediaMingle推广追踪器: 开始追踪点击', this.referralData);

    try {
        const requestData = {
            promotionCode: this.referralData.fullCode,
            agentCode: this.referralData.agentCode,
            productType: this.referralData.productType,
            pageUrl: window.location.href,
            userAgent: navigator.userAgent,
            referrer: document.referrer,
            timestamp: Date.now()
        };

        console.log('MediaMingle推广追踪器: 发送请求数据', requestData);
        console.log('MediaMingle推广追踪器: API地址', `${this.apiBaseUrl}/trackReferralClick`);

        const response = await fetch(`${this.apiBaseUrl}/trackReferralClick`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        console.log('MediaMingle推广追踪器: API响应状态', response.status);
        console.log('MediaMingle推广追踪器: API响应头', response.headers);

        if (response.ok) {
            const result = await response.json();
            console.log('MediaMingle推广点击记录成功:', result);
        } else {
            const errorText = await response.text();
            console.error('MediaMingle推广点击记录失败:', response.status, errorText);
        }
    } catch (error) {
        console.error('MediaMingle推广点击记录异常:', error);
    }
}
```

### 2. 增强转化追踪调试

**文件**：`D:/GoogleMapsScrapeWeb/netlify/functions/business-logic.js`

**修复内容**：
```javascript
async function processReferralCommission(outTradeNo, customerEmail, productId) {
    try {
        console.log('开始处理推广佣金:', { outTradeNo, customerEmail, productId });
        
        const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);
        
        // 获取订单信息
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .select('*')
            .eq('out_trade_no', outTradeNo)
            .single();

        if (orderError || !order) {
            console.log('未找到订单信息，跳过推广佣金处理:', orderError);
            return;
        }

        console.log('找到订单信息:', order);

        // 检查订单中是否有推广信息
        let referralCode = order.referral_code;
        let agentCode = order.agent_code;

        console.log('订单推广信息:', { referralCode, agentCode });

        // 如果订单表中没有推广信息，尝试从临时表中获取
        if ((!referralCode || !agentCode)) {
            try {
                const { data: referralData, error: referralError } = await supabase
                    .from('referral_tracking')
                    .select('referral_code, agent_code')
                    .eq('out_trade_no', outTradeNo)
                    .single();

                if (!referralError && referralData) {
                    referralCode = referralCode || referralData.referral_code;
                    agentCode = agentCode || referralData.agent_code;
                    console.log('从临时表获取推广信息:', referralData);
                }
            } catch (error) {
                console.log('从临时表获取推广信息失败:', error.message);
            }
        }

        // 检查是否有推广信息
        const hasReferralInfo = (referralCode && referralCode.trim() !== '') || 
                              (agentCode && agentCode.trim() !== '');
        
        if (!hasReferralInfo) {
            console.log('订单无推广信息，跳过推广佣金处理');
            return;
        }

        console.log('开始处理推广佣金，推广码:', referralCode, '代理码:', agentCode);

        // ... 其余逻辑保持不变，但添加更多调试信息
    } catch (error) {
        console.error('处理推广佣金失败:', error);
    }
}
```

### 3. 修复trackReferralClick API

**文件**：`c:/Users/A/Downloads/Google-Maps-Backend-master/netlify/functions/trackReferralClick.js`

**修复内容**：
```javascript
exports.handler = async function (event, context) {
  try {
    console.log('收到推广点击追踪请求:', event.body);
    
    const { 
      promotionCode, 
      agentCode, 
      productType, 
      pageUrl, 
      userAgent, 
      referrer, 
      timestamp 
    } = JSON.parse(event.body || '{}');

    console.log('解析的请求数据:', {
      promotionCode,
      agentCode,
      productType,
      pageUrl,
      userAgent: userAgent ? '***' : 'undefined',
      referrer,
      timestamp
    });

    if (!promotionCode || !agentCode) {
      console.log('推广码或代理代码为空');
      return {
        statusCode: 400,
        headers: { "Access-Control-Allow-Origin": "*" },
        body: JSON.stringify({ message: "推广码和代理代码不能为空" }),
      };
    }

    // 1. 查找对应的推广记录
    console.log('查找推广记录:', promotionCode);
    const { data: promotion, error: promotionError } = await supabase
      .from('product_promotions')
      .select('*')
      .eq('promotion_code', promotionCode)
      .single();

    if (promotionError || !promotion) {
      console.error('推广记录不存在:', promotionError);
      return {
        statusCode: 404,
        headers: { "Access-Control-Allow-Origin": "*" },
        body: JSON.stringify({ message: "推广记录不存在" }),
      };
    }

    console.log('找到推广记录:', promotion);

    // 2. 记录点击
    console.log('记录点击到promotion_clicks表');
    const { data: click, error: clickError } = await supabase
      .from('promotion_clicks')
      .insert([{
        promotion_code: promotionCode,
        agent_id: promotion.agent_id,
        ip_address: event.headers['x-forwarded-for'] || event.headers['x-real-ip'] || 'unknown',
        user_agent: userAgent,
        referrer: referrer,
        clicked_at: new Date(timestamp).toISOString()
      }])
      .select()
      .single();

    if (clickError) {
      console.error('记录点击失败:', clickError);
      return {
        statusCode: 500,
        headers: { "Access-Control-Allow-Origin": "*" },
        body: JSON.stringify({ message: "记录点击失败" }),
      };
    }

    console.log('点击记录成功:', click);

    // 3. 更新推广记录的点击次数
    console.log('更新推广记录点击次数');
    const { error: updateError } = await supabase
      .from('product_promotions')
      .update({ 
        clicks_count: promotion.clicks_count + 1,
        updated_at: new Date().toISOString()
      })
      .eq('id', promotion.id);

    if (updateError) {
      console.error('更新点击次数失败:', updateError);
    } else {
      console.log('点击次数更新成功');
    }

    return {
      statusCode: 200,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({
        message: "点击记录成功",
        data: {
          clickId: click.id,
          promotionCode: promotionCode,
          agentCode: agentCode,
          productType: productType
        }
      }),
    };

  } catch (error) {
    console.error('追踪推广点击函数出错:', error);
    return {
      statusCode: 500,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "服务器内部错误", error: error.message }),
    };
  }
};
```

### 4. 检查数据库表结构

**需要确认的表**：
1. `product_promotions` - 推广记录表
2. `promotion_clicks` - 点击记录表
3. `product_orders` - 产品订单表
4. `orders` - 订单表

**检查SQL**：
```sql
-- 检查推广记录表
SELECT * FROM product_promotions WHERE promotion_code = 'V9QGKNTF_google-maps_1759113776066_98mb0';

-- 检查点击记录表
SELECT * FROM promotion_clicks WHERE promotion_code = 'V9QGKNTF_google-maps_1759113776066_98mb0';

-- 检查订单表
SELECT * FROM orders WHERE referral_code = 'V9QGKNTF_google-maps_1759113776066_98mb0';
```

## 测试步骤

### 1. 部署修复

```bash
# 部署前端修复
cd "D:/GoogleMapsScrapeWeb"
git add assets/js/referral-tracker.js
git add netlify/functions/business-logic.js
git commit -m "增强推广链接追踪调试信息"
git push origin main

# 部署后端修复
cd "c:/Users/A/Downloads/Google-Maps-Backend-master"
git add netlify/functions/trackReferralClick.js
git commit -m "增强推广点击追踪API调试信息"
git push origin main
```

### 2. 测试点击追踪

1. 访问推广链接：`https://mediamingle.cn/product.html?id=maps-scraper&ref=V9QGKNTF_google-maps_1759113776066_98mb0`
2. 打开浏览器开发者工具（F12）
3. 查看Console标签页的调试信息
4. 确认点击追踪API是否被调用

### 3. 测试转化追踪

1. 完成下单流程
2. 查看Netlify Functions日志
3. 确认转化追踪逻辑是否执行
4. 检查数据库记录是否更新

### 4. 验证代理仪表板

1. 登录代理仪表板
2. 检查推广点击量是否更新
3. 检查产品转化数是否更新
4. 检查产品佣金是否更新

## 常见问题排查

### 1. 点击追踪失败

**可能原因**：
- API地址不正确
- 推广码解析错误
- 网络请求失败

**排查方法**：
- 检查浏览器控制台错误
- 验证API地址配置
- 检查推广码格式

### 2. 转化追踪失败

**可能原因**：
- 订单表中没有推广信息
- 推广码不匹配
- 数据库更新失败

**排查方法**：
- 检查订单表数据
- 验证推广码匹配
- 查看数据库日志

### 3. 代理仪表板不更新

**可能原因**：
- 数据查询逻辑错误
- 缓存问题
- 权限问题

**排查方法**：
- 检查数据库查询
- 清除浏览器缓存
- 验证用户权限

## 总结

通过这次修复，我们：

1. ✅ **增强调试信息**：添加详细的日志记录
2. ✅ **修复API逻辑**：改进错误处理和响应
3. ✅ **优化追踪流程**：确保数据正确传递
4. ✅ **提供测试方案**：完整的测试和排查步骤

修复完成后，推广链接追踪功能应该能够正常工作，代理仪表板的数据也会正确更新！
