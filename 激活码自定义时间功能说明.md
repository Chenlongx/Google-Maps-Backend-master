# ProMail Extractor 激活码自定义时间功能说明

## 功能概述

为Google-Maps-Backend-master后端项目的ProMail Extractor激活码管理功能添加了自定义时间选择功能，允许管理员在生成激活码时自主选择开始时间和结束时间。

## 主要功能

### 1. 时间设置方式

- **按天数设置**：传统的设置方式，从当前时间开始计算有效期天数
- **自定义时间**：可以精确设置激活码的开始时间和结束时间

### 2. 时间验证

- 开始时间必须早于结束时间
- 激活码有效期不能超过10年
- 支持精确到分钟的时间设置

## 技术实现

### 1. 数据库表结构更新

**文件：** `activation_codes_table.sql`

```sql
-- 添加开始时间字段
ALTER TABLE activation_codes ADD COLUMN start_date TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_activation_codes_start_date ON activation_codes(start_date);
```

### 2. 后端API更新

**文件：** `netlify/functions/generate-activation-codes.js`

#### 新增参数支持：
- `startDate`: 开始时间（ISO格式）
- `endDate`: 结束时间（ISO格式）
- `validDays`: 有效期天数（传统方式）

#### 时间处理逻辑：
```javascript
if (startDate && endDate) {
    // 使用自定义开始和结束时间
    startTime = new Date(startDate);
    endTime = new Date(endDate);
    
    // 验证时间
    if (startTime >= endTime) {
        return { success: false, message: '开始时间必须早于结束时间' };
    }
    
    // 检查时间范围（最多10年）
    const maxDuration = 10 * 365 * 24 * 60 * 60 * 1000;
    if (endTime.getTime() - startTime.getTime() > maxDuration) {
        return { success: false, message: '激活码有效期不能超过10年' };
    }
} else if (validDays) {
    // 使用传统的天数计算方式
    const now = new Date();
    startTime = now;
    endTime = new Date(now.getTime() + validDays * 24 * 60 * 60 * 1000);
}
```

### 3. 前端UI更新

**文件：** `public/pages/activation-codes.html`

#### 新增UI组件：
- 时间设置方式选择（单选按钮）
- 开始时间选择器（datetime-local）
- 结束时间选择器（datetime-local）

#### 表单结构：
```html
<!-- 时间设置方式选择 -->
<div class="form-group">
    <label>时间设置方式:</label>
    <div class="radio-group">
        <label class="radio-label">
            <input type="radio" name="timeMode" value="days" checked>
            <span>按天数设置</span>
        </label>
        <label class="radio-label">
            <input type="radio" name="timeMode" value="custom">
            <span>自定义时间</span>
        </label>
    </div>
</div>

<!-- 按天数设置 -->
<div id="daysMode" class="form-group">
    <label for="validDays">有效期(天):</label>
    <input type="number" id="validDays" min="1" max="3650" value="365" class="form-input">
</div>

<!-- 自定义时间设置 -->
<div id="customMode" class="form-group" style="display: none;">
    <div class="form-row">
        <div class="form-col">
            <label for="startDate">开始时间:</label>
            <input type="datetime-local" id="startDate" class="form-input">
        </div>
        <div class="form-col">
            <label for="endDate">结束时间:</label>
            <input type="datetime-local" id="endDate" class="form-input">
        </div>
    </div>
</div>
```

### 4. 表格显示更新

#### 新增列：
- 开始时间列：显示激活码开始生效的时间

#### 表格结构：
```html
<thead>
    <tr>
        <th>ID</th>
        <th>激活码</th>
        <th>状态</th>
        <th>创建时间</th>
        <th>开始时间</th>  <!-- 新增列 -->
        <th>过期时间</th>
        <th>使用时间</th>
        <th>用户名</th>
        <th>邮箱</th>
        <th>备注</th>
        <th>操作</th>
    </tr>
</thead>
```

### 5. JavaScript逻辑更新

#### 时间模式切换：
```javascript
// 时间模式切换事件
document.querySelectorAll('input[name="timeMode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const daysMode = document.getElementById('daysMode');
        const customMode = document.getElementById('customMode');
        
        if (this.value === 'days') {
            daysMode.style.display = 'block';
            customMode.style.display = 'none';
        } else {
            daysMode.style.display = 'none';
            customMode.style.display = 'block';
            
            // 设置默认时间
            const now = new Date();
            const oneYearLater = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = now.toISOString().slice(0, 16);
            document.getElementById('endDate').value = oneYearLater.toISOString().slice(0, 16);
        }
    });
});
```

#### 生成激活码逻辑：
```javascript
async function generateCodes() {
    const timeMode = document.querySelector('input[name="timeMode"]:checked').value;
    
    let requestData = {
        quantity: count,
        notes: notes
    };

    if (timeMode === 'days') {
        const validDays = parseInt(document.getElementById('validDays').value);
        requestData.validDays = validDays;
    } else {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showTimedAlert('请选择开始时间和结束时间');
            return;
        }
        
        const startTime = new Date(startDate);
        const endTime = new Date(endDate);
        
        if (startTime >= endTime) {
            showTimedAlert('开始时间必须早于结束时间');
            return;
        }
        
        requestData.startDate = startDate;
        requestData.endDate = endDate;
    }
    
    // 发送请求...
}
```

## 使用说明

### 1. 按天数设置（传统方式）

1. 选择"按天数设置"选项
2. 输入有效期天数（1-3650天）
3. 点击"生成"按钮

### 2. 自定义时间设置

1. 选择"自定义时间"选项
2. 设置开始时间（激活码开始生效的时间）
3. 设置结束时间（激活码过期的时间）
4. 点击"生成"按钮

### 3. 时间验证规则

- 开始时间必须早于结束时间
- 激活码有效期不能超过10年
- 时间格式：YYYY-MM-DDTHH:MM

## 数据库迁移

如果已有激活码数据，需要添加开始时间字段：

```sql
-- 为现有记录添加开始时间（使用创建时间作为开始时间）
UPDATE activation_codes 
SET start_date = created_at 
WHERE start_date IS NULL;
```

## 兼容性

- 向后兼容：支持传统的按天数设置方式
- 数据库兼容：新字段有默认值，不影响现有数据
- API兼容：新参数为可选参数，不影响现有调用

## 测试建议

1. **功能测试**：
   - 测试按天数设置功能
   - 测试自定义时间设置功能
   - 测试时间验证逻辑

2. **边界测试**：
   - 测试最大有效期（10年）
   - 测试最小时间间隔（1分钟）
   - 测试无效时间格式

3. **UI测试**：
   - 测试时间模式切换
   - 测试表单验证
   - 测试响应式布局

## 文件清单

### 修改的文件：
1. `netlify/functions/generate-activation-codes.js` - 后端API
2. `netlify/functions/get-activation-codes.js` - 获取激活码API
3. `activation_codes_table.sql` - 数据库表结构
4. `public/pages/activation-codes.html` - 前端页面

### 新增功能：
- 自定义时间选择器
- 时间模式切换
- 开始时间列显示
- 时间验证逻辑

## 总结

成功为ProMail Extractor激活码管理功能添加了自定义时间选择功能，提供了更灵活的时间管理选项，同时保持了向后兼容性。管理员现在可以精确控制激活码的有效期，满足不同的业务需求。
